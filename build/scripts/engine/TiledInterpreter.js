/**
 * Methods for interpreting Tiled map data into the game
 * intended to extend Phaser.State
 */
var TiledInterpreter = {
  preloadTilemap: function preloadTilemap(name, jsonLocation) {
    var _this = this;

    this.load.onFileComplete.add(function (progress, key) {
      if (key === name) {
        _this.preloadTilemapAssets(name);
      }
    });
    this.load.tilemap(name, jsonLocation, null, Phaser.Tilemap.TILED_JSON);
  },
  preloadTilemapAssets: function preloadTilemapAssets(name) {
    var _this2 = this;

    this.tilemap = this.cache.getTilemapData(name);
    // load tileset images
    this.tilemap.data.tilesets.forEach(function (set) {
      // TODO fix this set.image.replace regex hack, this is essentially hard coded
      _this2.load.image(set.name, 'assets/' + set.image.replace(/(\.\.\/)+/, ''));
    });
    // load object sprites
    this.getSpritesFromTilemap(this.tilemap).forEach(function (object) {
      _this2.load.spritesheet(object.properties.sprite, 'assets/' + object.properties.sprite.replace(/(\.\.\/)+/, ''), object.width, object.height);
    });
  },
  getSpritesFromTilemap: function getSpritesFromTilemap(tilemap) {
    var objectsBySpriteMap = tilemap.data.layers.reduce(function (objectsBySprite, layer) {
      if (layer.objects) {
        layer.objects.forEach(function (object) {
          if (object.properties && object.properties.sprite && !objectsBySprite[object.properties.sprite]) {
            objectsBySprite[object.properties.sprite] = object;
          }
        });
      }
      return objectsBySprite;
    }, {});
    return Object.keys(objectsBySpriteMap).map(function (key) {
      return objectsBySpriteMap[key];
    });
  },
  createTilemap: function createTilemap(name) {
    var map = this.game.add.tilemap(name);
    this.tilemap.data.tilesets.forEach(function (set) {
      map.addTilesetImage(set.name, set.name, set.tilewidth, set.tileheight);
    });

    return map;
  },
  initiateTiledObjectGroups: function initiateTiledObjectGroups(map) {
    var _this3 = this;

    // TODO need more data about objects/entities in tiled in order to do this
    var groups = {};
    var objectsByType = this.arrangeObjectsByType(map.objects);
    Object.keys(objectsByType).forEach(function (type) {
      groups[type] = _this3.game.add.group();
      groups[type].enableBody = true;
      objectsByType[type].forEach(function (item) {
        return _this3.createSpriteFromTiledObject(item, groups[type]);
      });
    });
    return groups;
  },
  arrangeObjectsByType: function arrangeObjectsByType(objects) {
    return objects.reduce(function (objects, object) {
      if (object.type) {
        if (!objects[object.type]) {
          objects[object.type] = [];
        }
        objects[object.type].push(object);
      } else {
        console.warn('object found without type', object.name, object);
      }
      return objects;
    }, {});
  },
  getObjectsFromTilemap: function getObjectsFromTilemap(tilemap) {
    return tilemap.data.layers.reduce(function (objects, layer) {
      if (layer.objects) {
        objects = objects.concat(layer.objects);
      }
      return objects;
    }, []);
  },

  /**
   * Creates a Phaser sprite in a sprite group from a Tiled object
   * @param  {object} object The Tiled object
   * @param  {group} group   The Phaser sprite group
   * @return {Sprite}        The Phaser sprite
   */
  createSpriteFromTiledObject: function createSpriteFromTiledObject(object, group) {
    if (!object.properties || !object.properties.sprite) {
      console.error('no sprite defined for object', object);
      return;
    }
    var sprite = group.create(object.x, object.y - object.height, object.properties.sprite);
    sprite.gameData = {
      name: object.name,
      type: object.type
    };
    Object.assign(sprite.gameData, object.properties);
    return sprite;
  }
};

export default TiledInterpreter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zY3JpcHRzL2VuZ2luZS9UaWxlZEludGVycHJldGVyLmpzIl0sIm5hbWVzIjpbIlRpbGVkSW50ZXJwcmV0ZXIiLCJwcmVsb2FkVGlsZW1hcCIsIm5hbWUiLCJqc29uTG9jYXRpb24iLCJsb2FkIiwib25GaWxlQ29tcGxldGUiLCJhZGQiLCJwcm9ncmVzcyIsImtleSIsInByZWxvYWRUaWxlbWFwQXNzZXRzIiwidGlsZW1hcCIsIlBoYXNlciIsIlRpbGVtYXAiLCJUSUxFRF9KU09OIiwiY2FjaGUiLCJnZXRUaWxlbWFwRGF0YSIsImRhdGEiLCJ0aWxlc2V0cyIsImZvckVhY2giLCJpbWFnZSIsInNldCIsInJlcGxhY2UiLCJnZXRTcHJpdGVzRnJvbVRpbGVtYXAiLCJzcHJpdGVzaGVldCIsIm9iamVjdCIsInByb3BlcnRpZXMiLCJzcHJpdGUiLCJ3aWR0aCIsImhlaWdodCIsIm9iamVjdHNCeVNwcml0ZU1hcCIsImxheWVycyIsInJlZHVjZSIsIm9iamVjdHNCeVNwcml0ZSIsImxheWVyIiwib2JqZWN0cyIsIk9iamVjdCIsImtleXMiLCJtYXAiLCJjcmVhdGVUaWxlbWFwIiwiZ2FtZSIsImFkZFRpbGVzZXRJbWFnZSIsInRpbGV3aWR0aCIsInRpbGVoZWlnaHQiLCJpbml0aWF0ZVRpbGVkT2JqZWN0R3JvdXBzIiwiZ3JvdXBzIiwib2JqZWN0c0J5VHlwZSIsImFycmFuZ2VPYmplY3RzQnlUeXBlIiwidHlwZSIsImdyb3VwIiwiZW5hYmxlQm9keSIsImNyZWF0ZVNwcml0ZUZyb21UaWxlZE9iamVjdCIsIml0ZW0iLCJwdXNoIiwiY29uc29sZSIsIndhcm4iLCJnZXRPYmplY3RzRnJvbVRpbGVtYXAiLCJjb25jYXQiLCJlcnJvciIsImNyZWF0ZSIsIngiLCJ5IiwiZ2FtZURhdGEiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBSUEsSUFBTUEsbUJBQW1CO0FBQ3ZCQyxnQkFEdUIsMEJBQ1JDLElBRFEsRUFDRkMsWUFERSxF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LE9BQVA7QUFDRCxLQUxNLEVBS0osRUFMSSxDQUFQO0FBTUQsR0FuRnNCOztBQW9GdkI7Ozs7OztBQU1BZ0IsNkJBMUZ1Qix1Q0EwRksxQixNQTFGTCxFQTBGYXdCLEtBMUZiLEVBMEZvQjtBQUN6QyxRQUFJLENBQUN4QixPQUFPQyxVQUFSLElBQXNCLENBQUNELE9BQU9DLFVBQVAsQ0FBa0JDLE1BQTdDLEVBQXFEO0FBQ25EMkIsY0FBUUksS0FBUixDQUFjLDhCQUFkLEVBQThDakMsTUFBOUM7QUFDQTtBQUNEO0FBQ0QsUUFBTUUsU0FBU3NCLE1BQU1VLE1BQU4sQ0FBYWxDLE9BQU9tQyxDQUFwQixFQUF1Qm5DLE9BQU9vQyxDQUFQLEdBQVdwQyxPQUFPSSxNQUF6QyxFQUFpREosT0FBT0MsVUFBUCxDQUFrQkMsTUFBbkUsQ0FBZjtBQUNBQSxXQUFPbUMsUUFBUCxHQUFrQjtBQUNoQjNELFlBQU1zQixPQUFPdEIsSUFERztBQUVoQjZDLFlBQU12QixPQUFPdUI7QUFGRyxLQUFsQjtBQUlBWixXQUFPMkIsTUFBUCxDQUFjcEMsT0FBT21DLFFBQXJCLEVBQStCckMsT0FBT0MsVUFBdEM7QUFDQSxXQUFPQyxNQUFQO0FBQ0Q7QUF0R3NCLENBQXpCOztBQXlHQSxlQUFlMUIsZ0JBQWYiLCJmaWxlIjoiVGlsZWRJbnRlcnByZXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTWV0aG9kcyBmb3IgaW50ZXJwcmV0aW5nIFRpbGVkIG1hcCBkYXRhIGludG8gdGhlIGdhbWVcbiAqIGludGVuZGVkIHRvIGV4dGVuZCBQaGFzZXIuU3RhdGVcbiAqL1xuY29uc3QgVGlsZWRJbnRlcnByZXRlciA9IHtcbiAgcHJlbG9hZFRpbGVtYXAobmFtZSwganNvbkxvY2F0aW9uKSB7XG4gICAgdGhpcy5sb2FkLm9uRmlsZUNvbXBsZXRlLmFkZCgocHJvZ3Jlc3MsIGtleSkgPT4ge1xuICAgICAgaWYgKGtleSA9PT0gbmFtZSkge1xuICAgICAgICB0aGlzLnByZWxvYWRUaWxlbWFwQXNzZXRzKG5hbWUpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMubG9hZC50aWxlbWFwKG5hbWUsIGpzb25Mb2NhdGlvbiwgbnVsbCwgUGhhc2VyLlRpbGVtYXAuVElMRURfSlNPTik7XG4gIH0sXG4gIHByZWxvYWRUaWxlbWFwQXNzZXRzKG5hbWUpIHtcbiAgICB0aGlzLnRpbGVtYXAgPSB0aGlzLmNhY2hlLmdldFRpbGVtYXBEYXRhKG5hbWUpO1xuICAgIC8vIGxvYWQgdGlsZXNldCBpbWFnZXNcbiAgICB0aGlzLnRpbGVtYXAuZGF0YS50aWxlc2V0cy5mb3JFYWNoKHNldCA9PiB7XG4gICAgICAvLyBUT0RPIGZpeCB0aGlzIHNldC5pbWFnZS5yZXBsYWNlIHJlZ2V4IGhhY2ssIHRoaXMgaXMgZXNzZW50aWFsbHkgaGFyZCBjb2RlZFxuICAgICAgdGhpcy5sb2FkLmltYWdlKHNldC5uYW1lLCBgYXNzZXRzLyR7c2V0LmltYWdlLnJlcGxhY2UoLyhcXC5cXC5cXC8pKy8sICcnKX1gKTtcbiAgICB9KTtcbiAgICAvLyBsb2FkIG9iamVjdCBzcHJpdGVzXG4gICAgdGhpcy5nZXRTcHJpdGVzRnJvbVRpbGVtYXAodGhpcy50aWxlbWFwKS5mb3JFYWNoKG9iamVjdCA9PiB7XG4gICAgICB0aGlzLmxvYWQuc3ByaXRlc2hlZXQoXG4gICAgICAgIG9iamVjdC5wcm9wZXJ0aWVzLnNwcml0ZSxcbiAgICAgICAgYGFzc2V0cy8ke29iamVjdC5wcm9wZXJ0aWVzLnNwcml0ZS5yZXBsYWNlKC8oXFwuXFwuXFwvKSsvLCAnJyl9YCxcbiAgICAgICAgb2JqZWN0LndpZHRoLFxuICAgICAgICBvYmplY3QuaGVpZ2h0XG4gICAgICApO1xuICAgIH0pO1xuICB9LFxuICBnZXRTcHJpdGVzRnJvbVRpbGVtYXAodGlsZW1hcCkge1xuICAgIGNvbnN0IG9iamVjdHNCeVNwcml0ZU1hcCA9IHRpbGVtYXAuZGF0YS5sYXllcnMucmVkdWNlKChvYmplY3RzQnlTcHJpdGUsIGxheWVyKSA9PiB7XG4gICAgICBpZiAobGF5ZXIub2JqZWN0cykge1xuICAgICAgICBsYXllci5vYmplY3RzLmZvckVhY2gob2JqZWN0ID0+IHtcbiAgICAgICAgICBpZiAob2JqZWN0LnByb3BlcnRpZXMgJiYgb2JqZWN0LnByb3BlcnRpZXMuc3ByaXRlICYmICFvYmplY3RzQnlTcHJpdGVbb2JqZWN0LnByb3BlcnRpZXMuc3ByaXRlXSkge1xuICAgICAgICAgICAgb2JqZWN0c0J5U3ByaXRlW29iamVjdC5wcm9wZXJ0aWVzLnNwcml0ZV0gPSBvYmplY3Q7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBvYmplY3RzQnlTcHJpdGU7XG4gICAgfSwge30pO1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmplY3RzQnlTcHJpdGVNYXApLm1hcChrZXkgPT4gb2JqZWN0c0J5U3ByaXRlTWFwW2tleV0pO1xuICB9LFxuICBjcmVhdGVUaWxlbWFwKG5hbWUpIHtcbiAgICBjb25zdCBtYXAgPSB0aGlzLmdhbWUuYWRkLnRpbGVtYXAobmFtZSk7XG4gICAgdGhpcy50aWxlbWFwLmRhdGEudGlsZXNldHMuZm9yRWFjaChzZXQgPT4ge1xuICAgICAgbWFwLmFkZFRpbGVzZXRJbWFnZShcbiAgICAgICAgc2V0Lm5hbWUsXG4gICAgICAgIHNldC5uYW1lLFxuICAgICAgICBzZXQudGlsZXdpZHRoLFxuICAgICAgICBzZXQudGlsZWhlaWdodFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBtYXA7XG4gIH0sXG4gIGluaXRpYXRlVGlsZWRPYmplY3RHcm91cHMobWFwKSB7XG4gICAgLy8gVE9ETyBuZWVkIG1vcmUgZGF0YSBhYm91dCBvYmplY3RzL2VudGl0aWVzIGluIHRpbGVkIGluIG9yZGVyIHRvIGRvIHRoaXNcbiAgICBjb25zdCBncm91cHMgPSB7fTtcbiAgICBjb25zdCBvYmplY3RzQnlUeXBlID0gdGhpcy5hcnJhbmdlT2JqZWN0c0J5VHlwZShtYXAub2JqZWN0cyk7XG4gICAgT2JqZWN0LmtleXMob2JqZWN0c0J5VHlwZSkuZm9yRWFjaCh0eXBlID0+IHtcbiAgICAgIGdyb3Vwc1t0eXBlXSA9IHRoaXMuZ2FtZS5hZGQuZ3JvdXAoKTtcbiAgICAgIGdyb3Vwc1t0eXBlXS5lbmFibGVCb2R5ID0gdHJ1ZTtcbiAgICAgIG9iamVjdHNCeVR5cGVbdHlwZV0uZm9yRWFjaChpdGVtID0+IHRoaXMuY3JlYXRlU3ByaXRlRnJvbVRpbGVkT2JqZWN0KGl0ZW0sIGdyb3Vwc1t0eXBlXSkpO1xuICAgIH0pO1xuICAgIHJldHVybiBncm91cHM7XG4gIH0sXG4gIGFycmFuZ2VPYmplY3RzQnlUeXBlKG9iamVjdHMpIHtcbiAgICByZXR1cm4gb2JqZWN0cy5yZWR1Y2UoKG9iamVjdHMsIG9iamVjdCkgPT4ge1xuICAgICAgaWYgKG9iamVjdC50eXBlKSB7XG4gICAgICAgIGlmICghb2JqZWN0c1tvYmplY3QudHlwZV0pIHtcbiAgICAgICAgICBvYmplY3RzW29iamVjdC50eXBlXSA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIG9iamVjdHNbb2JqZWN0LnR5cGVdLnB1c2gob2JqZWN0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUud2Fybignb2JqZWN0IGZvdW5kIHdpdGhvdXQgdHlwZScsIG9iamVjdC5uYW1lLCBvYmplY3QpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG9iamVjdHM7XG4gICAgfSwge30pO1xuICB9LFxuICBnZXRPYmplY3RzRnJvbVRpbGVtYXAodGlsZW1hcCkge1xuICAgIHJldHVybiB0aWxlbWFwLmRhdGEubGF5ZXJzLnJlZHVjZSgob2JqZWN0cywgbGF5ZXIpID0+IHtcbiAgICAgIGlmIChsYXllci5vYmplY3RzKSB7XG4gICAgICAgIG9iamVjdHMgPSBvYmplY3RzLmNvbmNhdChsYXllci5vYmplY3RzKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBvYmplY3RzO1xuICAgIH0sIFtdKTtcbiAgfSxcbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBQaGFzZXIgc3ByaXRlIGluIGEgc3ByaXRlIGdyb3VwIGZyb20gYSBUaWxlZCBvYmplY3RcbiAgICogQHBhcmFtICB7b2JqZWN0fSBvYmplY3QgVGhlIFRpbGVkIG9iamVjdFxuICAgKiBAcGFyYW0gIHtncm91cH0gZ3JvdXAgICBUaGUgUGhhc2VyIHNwcml0ZSBncm91cFxuICAgKiBAcmV0dXJuIHtTcHJpdGV9ICAgICAgICBUaGUgUGhhc2VyIHNwcml0ZVxuICAgKi9cbiAgY3JlYXRlU3ByaXRlRnJvbVRpbGVkT2JqZWN0KG9iamVjdCwgZ3JvdXApIHtcbiAgICBpZiAoIW9iamVjdC5wcm9wZXJ0aWVzIHx8ICFvYmplY3QucHJvcGVydGllcy5zcHJpdGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ25vIHNwcml0ZSBkZWZpbmVkIGZvciBvYmplY3QnLCBvYmplY3QpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBzcHJpdGUgPSBncm91cC5jcmVhdGUob2JqZWN0LngsIG9iamVjdC55IC0gb2JqZWN0LmhlaWdodCwgb2JqZWN0LnByb3BlcnRpZXMuc3ByaXRlKTtcbiAgICBzcHJpdGUuZ2FtZURhdGEgPSB7XG4gICAgICBuYW1lOiBvYmplY3QubmFtZSxcbiAgICAgIHR5cGU6IG9iamVjdC50eXBlXG4gICAgfTtcbiAgICBPYmplY3QuYXNzaWduKHNwcml0ZS5nYW1lRGF0YSwgb2JqZWN0LnByb3BlcnRpZXMpO1xuICAgIHJldHVybiBzcHJpdGU7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IFRpbGVkSW50ZXJwcmV0ZXI7XG4iXX0=